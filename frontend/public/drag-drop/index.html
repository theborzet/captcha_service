<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Drag & Drop Captcha</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    #captcha-container {
      position: relative;
      width: 320px;
      height: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    #target {
      position: absolute;
      width: 60px;
      height: 60px;
      background: #e3f2fd;
      border: 2px dashed #1976d2;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #1976d2;
      font-size: 12px;
      user-select: none;
    }

    #draggable {
      position: absolute;
      left: 20px;
      top: 70px;
      width: 60px;
      height: 60px;
      background: #4caf50;
      color: white;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 12px;
      cursor: grab;
      user-select: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }

    #draggable:active {
      cursor: grabbing;
      transform: scale(1.1);
    }

    .success {
      background: #4caf50 !important;
      color: white !important;
      border: 2px solid white !important;
    }

    .fail {
      background: #f44336 !important;
      color: white !important;
    }

    button {
      margin: 10px;
      padding: 8px 16px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: none;
    }

    button:hover {
      background: #1565c0;
    }
  </style>
</head>
<body>
  <div id="captcha-container"></div>
  <button id="retry">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>

  <script>
    const HOST = window.location.hostname || 'localhost';
    const ws = new WebSocket(`ws://${HOST}:8080/ws`);
    const container = document.getElementById('captcha-container');
    const retryButton = document.getElementById('retry');

    let isCaptchaLoaded = false;

    ws.onopen = () => {
      if (!isCaptchaLoaded) {
        loadCaptcha();
        isCaptchaLoaded = true;
      }
    };

    ws.onmessage = (event) => {
      const serverEvent = JSON.parse(event.data);
      console.log('–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', serverEvent);  // ‚úÖ –ª–æ–≥ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

      const result = serverEvent?.Event?.Result;
      if (result) {
        const { challenge_id, confidence_percent } = result;
        updateCaptchaUI(confidence_percent, challenge_id);
      } else {
        console.warn('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', serverEvent);
      }
    };

    ws.onerror = (error) => {
      console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
    };

    ws.onclose = () => {
      console.log('WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
    };

    function loadCaptcha() {
      fetch(`http://${HOST}:8080/captcha`)
        .then(response => response.text())
        .then(html => {
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = html.trim();
          const newContainer = tempDiv.firstElementChild;

          if (!newContainer || newContainer.id !== 'captcha-container') {
            throw new Error('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π HTML –∫–∞–ø—á–∏');
          }

          const challengeId = newContainer.dataset.challengeId;
          const targetX = newContainer.dataset.targetX;
          const targetY = newContainer.dataset.targetY;

          if (challengeId) {
            localStorage.setItem('captchaChallengeId', challengeId);
          }

          container.innerHTML = '';
          container.dataset.challengeId = challengeId;
          container.dataset.targetX = targetX;
          container.dataset.targetY = targetY;

          const target = document.createElement('div');
          target.id = 'target';
          target.textContent = 'üéØ –¶–µ–ª—å';
          container.appendChild(target);

          const draggable = document.createElement('div');
          draggable.id = 'draggable';
          draggable.textContent = 'üëâ –ü–µ—Ä–µ—Ç–∞—â–∏';
          container.appendChild(draggable);

          initCaptcha();
        })
        .catch(err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ø—á–∏:', err);
        });
    }

    function initCaptcha() {
      const draggable = document.getElementById('draggable');
      const target = document.getElementById('target');
      if (!draggable || !target) return;

      const challengeId = localStorage.getItem('captchaChallengeId');
      const targetX = parseInt(container.dataset.targetX) || 260;
      const targetY = parseInt(container.dataset.targetY) || 70;

      target.style.left = `${targetX}px`;
      target.style.top = `${targetY}px`;

      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
      draggable.style.pointerEvents = 'auto';
      draggable.classList.remove('success', 'fail');
      draggable.innerText = 'üëâ –ü–µ—Ä–µ—Ç–∞—â–∏';
      retryButton.style.display = 'none';

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
      draggable.onmousedown = null;
      document.onmousemove = null;
      document.onmouseup = null;

      let isDragging = false;
      let offsetX, offsetY;

      draggable.onmousedown = (e) => {
        isDragging = true;
        const rect = draggable.getBoundingClientRect();
        offsetX = e.clientX - rect.left;
        offsetY = e.clientY - rect.top;
        draggable.style.cursor = 'grabbing';
      };

      document.onmousemove = (e) => {
        if (!isDragging) return;
        const containerRect = container.getBoundingClientRect();
        const x = e.clientX - offsetX - containerRect.left;
        const y = e.clientY - offsetY - containerRect.top;
        const minX = 0;
        const minY = 0;
        const maxX = containerRect.width - draggable.offsetWidth;
        const maxY = containerRect.height - draggable.offsetHeight;
        draggable.style.left = `${Math.max(minX, Math.min(maxX, x))}px`;
        draggable.style.top = `${Math.max(minY, Math.min(maxY, y))}px`;
      };

      document.onmouseup = (e) => {
        if (!isDragging) return;
        isDragging = false;
        draggable.style.cursor = 'grab';

        const draggableRect = draggable.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const relativeX = draggableRect.left - containerRect.left;
        const relativeY = draggableRect.top - containerRect.top;

        const isOverlapping = Math.abs(relativeX - targetX) < 50 && Math.abs(relativeY - targetY) < 50;

        ws.send(JSON.stringify({
          type: 'captcha:sendData',
          data: JSON.stringify({
            event: 'drag_drop',
            challenge_id: challengeId || '',
            x: Math.round(relativeX),
            y: Math.round(relativeY),
            success: isOverlapping
          })
        }));

        draggable.style.pointerEvents = 'none';
      };

      retryButton.onclick = () => {
        loadCaptcha();
      };
    }

    function updateCaptchaUI(confidencePercent, challengeId) {
      const draggable = container.querySelector('#draggable');
      const target = container.querySelector('#target');

      if (!draggable || !target) {
        console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ø—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ DOM');
        return;
      }

      if (challengeId && challengeId.startsWith('error:')) {
        draggable.className = 'fail';
        draggable.textContent = '‚ùå –û—à–∏–±–∫–∞';
        target.style.border = '2px solid #f44336';
      } else if (confidencePercent > 50) {
        draggable.className = 'success';
        draggable.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ!';
        target.style.border = '2px solid #4caf50';
      } else {
        draggable.className = 'fail';
        draggable.textContent = '‚ùå –ú–∏–º–æ!';
        target.style.border = '2px solid #f44336';
      }

      retryButton.style.display = 'block';
    }
  </script>
</body>
</html>
